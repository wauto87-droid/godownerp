<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Godown ERP System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }
    .header { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .header h1 { color: #667eea; font-size: 28px; margin-bottom: 5px; }
    .header p { color: #666; font-size: 14px; }
    .config-section { background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .config-section h3 { color: #856404; margin-bottom: 10px; font-size: 16px; }
    .config-section input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; margin-bottom: 10px; font-family: monospace; background: white; }
    .user-info { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; flex-wrap: wrap; gap: 10px; }
    .login-form { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .login-form label { font-weight: 600; margin-bottom: 5px; display: block; }
    .login-form input, .login-form select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover:not(:disabled) { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover:not(:disabled) { background: #5a6268; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover:not(:disabled) { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover:not(:disabled) { background: #c82333; }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: white; padding: 5px; border-radius: 10px; flex-wrap: wrap; }
    .tab-btn { padding: 12px 24px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; transition: all 0.3s ease; }
    .tab-btn:hover:not(:disabled) { background: #f0f0f0; }
    .tab-btn.active { background: #667eea; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-left: 4px solid #667eea; }
    .stat-card h3 { color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
    .stat-card .value { color: #667eea; font-size: 36px; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    table th { background: #667eea; color: white; padding: 15px; text-align: left; font-size: 13px; font-weight: 600; text-transform: uppercase; }
    table td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 14px; color: #444; }
    table tr:hover { background: #f8f9fa; }
    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .status-pending { background: #ffc107; color: #856404; }
    .status-approved { background: #28a745; color: white; }
    .status-rejected { background: #dc3545; color: white; }
    .status-closed { background: #6c757d; color: white; }
    .status-loaded { background: #28a745; color: white; }
    .status-partial { background: #17a2b8; color: white; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; color: #555; font-size: 13px; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: modalSlide 0.3s ease; }
    @keyframes modalSlide { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal h2 { color: #667eea; margin-bottom: 20px; font-size: 24px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    .alert { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; }
    .alert-success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .alert-error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .alert-warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    .table-container { max-height: 400px; overflow-y: auto; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .table-container::-webkit-scrollbar { width: 8px; }
    .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .table-container::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }
    .empty-state { text-align: center; padding: 40px; color: #999; }
    .loading { text-align: center; padding: 20px; color: #667eea; font-weight: bold; }
    .role-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .role-admin { background: #667eea; color: white; }
    .role-godown { background: #17a2b8; color: white; }
    .role-salesman { background: #ffc107; color: #856404; }
    .inventory-low { background: #f8d7da; color: #721c24; }
    .inventory-ok { background: #d4edda; color: #155724; }
    .transaction-in { color: #28a745; font-weight: bold; }
    .transaction-out { color: #dc3545; font-weight: bold; }
    .transaction-return { color: #17a2b8; font-weight: bold; }
    footer { text-align: center; padding: 20px; color: white; margin-top: 20px; }
    footer p { font-size: 13px; }
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: 1fr; }
      .tabs { flex-wrap: wrap; }
      .tab-btn { flex: 1; min-width: 100px; }
      table { font-size: 12px; }
      table th, table td { padding: 8px 10px; }
      .login-form { flex-direction: column; }
      .login-form input, .login-form select { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üèóÔ∏è Godown ERP System</h1>
      <p>Stock & Logistics Management with Google Sheets</p>
      
      <!-- Script URL Configuration -->
      <div class="config-section">
        <h3>‚öôÔ∏è Backend Configuration</h3>
        <label for="scriptUrlInput" style="font-weight: 600; margin-bottom: 5px; display: block;">
          üì° Google Apps Script Web App URL (must end with /exec):
        </label>
        <input 
          type="text" 
          id="scriptUrlInput" 
          placeholder="https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID_HERE/exec"
          style="font-family: monospace;"
        >
        <div style="margin-top: 10px;">
          <button class="btn btn-success" onclick="saveScriptUrl()">
            üíæ Save URL
          </button>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 8px; line-height: 1.4;">
          üí° <strong>How to get your URL:</strong><br>
          1. In Google Apps Script, click <strong>Deploy ‚Üí New deployment</strong><br>
          2. Click ‚öôÔ∏è (gear icon) ‚Üí Select <strong>Web app</strong><br>
          3. Execute as: <strong>Me</strong><br>
          4. Who has access: <strong>Anyone with Google account</strong><br>
          5. Click <strong>Deploy</strong><br>
          6. <strong>Copy the Web App URL</strong> (ends with /exec)
        </p>
      </div>
      
      <div class="user-info">
        <div class="login-form">
          <label for="userEmail">üìß Email:</label>
          <input type="email" id="userEmail" placeholder="user@example.com">
          
          <label for="userRole">üë§ Role:</label>
          <select id="userRole">
            <option value="SALESMAN">Salesman</option>
            <option value="GODOWN">Godown Keeper</option>
            <option value="ADMIN">Admin</option>
          </select>
          
          <button class="btn btn-primary" onclick="login()" id="loginBtn" disabled>
            üîë Login
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('dashboard')">üìä Dashboard</button>
        <button class="tab-btn" onclick="showTab('inventory')">üì¶ Inventory</button>
        <button class="tab-btn" onclick="showTab('bookings')">üõí Bookings</button>
        <button class="tab-btn" onclick="showTab('loadings')">üöõ Loadings</button>
        <button class="tab-btn" onclick="showTab('transactions')">üí≥ Transactions</button>
        <button class="tab-btn" id="auditTab" onclick="showTab('audit')" style="display: none;">
          üìã Audit Log
        </button>
      </div>

      <!-- Dashboard Tab -->
      <div id="dashboardTab" class="tab-content active">
        <div class="card">
          <h2>üìä Dashboard</h2>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <h3>Total Items</h3>
              <div class="value" id="totalItems">0</div>
            </div>
            <div class="stat-card">
              <h3>Total Bookings</h3>
              <div class="value" id="totalBookings">0</div>
            </div>
            <div class="stat-card">
              <h3>Pending Loadings</h3>
              <div class="value" id="pendingLoadings">0</div>
            </div>
            <div class="stat-card">
              <h3>Total Transactions</h3>
              <div class="value" id="totalTransactions">0</div>
            </div>
          </div>
          
          <div id="setupSection">
            <h3>üöÄ System Setup</h3>
            <p>Initialize system with demo data (creates all sheets and inserts demo users, items, and stock)</p>
            <button class="btn btn-primary" onclick="initializeSystem()">
              üöÄ Initialize System
            </button>
            <p style="font-size: 12px; color: #666; margin-top: 5px;">
              ‚ö†Ô∏è This may take 30-60 seconds to complete
            </p>
          </div>
        </div>
      </div>

      <!-- Inventory Tab -->
      <div id="inventoryTab" class="tab-content">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>üì¶ Inventory Management</h2>
            <button class="btn btn-primary" id="addItemBtn" onclick="openAddItemModal()" style="display: none;">
              ‚ûï Add Item
            </button>
          </div>
          
          <div class="table-container">
            <table id="inventoryTable">
              <thead>
                <tr>
                  <th>Item Name</th>
                  <th>Category</th>
                  <th>Unit</th>
                  <th>Min Stock</th>
                  <th>Current Stock</th>
                  <th>Reserved</th>
                  <th>Available</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Bookings Tab -->
      <div id="bookingsTab" class="tab-content">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>üõí Bookings</h2>
            <button class="btn btn-primary" id="createBookingBtn" onclick="openCreateBookingModal()" style="display: none;">
              ‚ûï Create Booking
            </button>
          </div>
          
          <div class="table-container">
            <table id="bookingsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Date</th>
                  <th>Shop</th>
                  <th>Item</th>
                  <th>Ordered Qty</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="bookingsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Loadings Tab -->
      <div id="loadingsTab" class="tab-content">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>üöõ Loadings</h2>
            <button class="btn btn-primary" id="createLoadingBtn" onclick="openCreateLoadingModal()" style="display: none;">
              ‚ûï Create Loading
            </button>
          </div>
          
          <div class="table-container">
            <table id="loadingsTable">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Booking ID</th>
                  <th>Item</th>
                  <th>Ordered</th>
                  <th>Loaded</th>
                  <th>Mode</th>
                  <th>Vehicle No</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="loadingsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Transactions Tab -->
      <div id="transactionsTab" class="tab-content">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>üí≥ Transactions</h2>
            <button class="btn btn-primary" id="createTransactionBtn" onclick="openCreateTransactionModal()" style="display: none;">
              ‚ûï Create Transaction
            </button>
          </div>
          
          <div class="alert alert-warning">
            ‚ö†Ô∏è <strong>IMPORTANT:</strong> Transactions are the ONLY way to change stock. All inventory values are calculated from transactions.
          </div>
          
          <div class="table-container">
            <table id="transactionsTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Item</th>
                  <th>Quantity</th>
                  <th>Source</th>
                  <th>Handled By</th>
                  <th>Remarks</th>
                </tr>
              </thead>
              <tbody id="transactionsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Audit Log Tab -->
      <div id="auditTab" class="tab-content">
        <div class="card">
          <h2>üìã Audit Log</h2>
          <div class="table-container">
            <table id="auditTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>User</th>
                  <th>Action</th>
                  <th>Details</th>
                  <th>Reference</th>
                </tr>
              </thead>
              <tbody id="auditTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <p>üèóÔ∏è Godown ERP System - Transaction-Based Stock Control ‚Ä¢ Audit-Safe ‚Ä¢ Multi-User</p>
    </footer>
  </div>

  <!-- Modals -->
  <div id="addItemModal" class="modal-overlay">
    <div class="modal">
      <h2>‚ûï Add New Item</h2>
      <div class="form-group">
        <label>Item Name *</label>
        <input type="text" id="newItemName" placeholder="e.g., Cement Bag">
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Category *</label>
          <input type="text" id="newItemCategory" placeholder="e.g., Construction">
        </div>
        <div class="form-group">
          <label>Unit *</label>
          <input type="text" id="newItemUnit" placeholder="e.g., Bag, Kg">
        </div>
      </div>
      <div class="form-group">
        <label>Minimum Stock</label>
        <input type="number" id="newItemMinStock" value="0">
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="newItemStatus">
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('addItemModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewItem()">Save Item</button>
      </div>
    </div>
  </div>

  <div id="createBookingModal" class="modal-overlay">
    <div class="modal">
      <h2>üõí Create New Booking</h2>
      <div class="form-group">
        <label>Shop *</label>
        <input type="text" id="newBookingShop" placeholder="e.g., ABC Hardware Store">
      </div>
      <div class="form-group">
        <label>Item *</label>
        <select id="newBookingItem">
          <option value="">Select an item...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Ordered Quantity *</label>
        <input type="number" id="newBookingQty" value="0" min="1">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('createBookingModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewBooking()">Create Booking</button>
      </div>
    </div>
  </div>

  <div id="createLoadingModal" class="modal-overlay">
    <div class="modal">
      <h2>üöõ Create New Loading</h2>
      <div class="form-group">
        <label>Booking *</label>
        <select id="newLoadingBooking">
          <option value="">Select a booking...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Loaded Quantity *</label>
        <input type="number" id="newLoadingQty" value="0" min="1">
        <small id="loadingMaxQty"></small>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Dispatch Mode</label>
          <select id="newLoadingMode">
            <option value="OWN_VEHICLE">Own Vehicle</option>
            <option value="COURIER">Courier</option>
          </select>
        </div>
        <div class="form-group">
          <label>Vehicle No</label>
          <input type="text" id="newLoadingVehicle" placeholder="e.g., MH 12 AB 1234">
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('createLoadingModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewLoading()">Create Loading</button>
      </div>
    </div>
  </div>

  <div id="createTransactionModal" class="modal-overlay">
    <div class="modal">
      <h2>üí≥ Create New Transaction</h2>
      <div class="alert alert-warning">
        ‚ö†Ô∏è This will directly change stock. Ensure you understand the impact.
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>Transaction Type *</label>
          <select id="newTransactionType">
            <option value="IN">IN (Stock In)</option>
            <option value="OUT">OUT (Stock Out)</option>
            <option value="RETURN">RETURN (Return)</option>
            <option value="ADJUST">ADJUST (Adjustment)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Source</label>
          <select id="newTransactionSource">
            <option value="PURCHASE">Purchase</option>
            <option value="LOADING">Loading</option>
            <option value="RETURN">Return</option>
            <option value="ADJUSTMENT">Adjustment</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Item *</label>
        <select id="newTransactionItem">
          <option value="">Select an item...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Quantity *</label>
        <input type="number" id="newTransactionQty" value="0">
      </div>
      <div class="form-group">
        <label>Remarks</label>
        <textarea id="newTransactionRemarks" placeholder="Optional notes..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('createTransactionModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveNewTransaction()">Create Transaction</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    
    let SCRIPT_URL = '';
    let currentUserEmail = '';
    let currentUserRole = '';
    let itemsData = [];

    // ============================================================================
    // API CLIENT
    // ============================================================================

    class GoogleSheetsAPI {
      constructor(scriptUrl, userEmail) {
        this.scriptUrl = scriptUrl;
        this.userEmail = userEmail;
      }

      async request(action, data = null) {
        try {
          console.log('üì§ Making API Request:', action);
          console.log('URL:', this.scriptUrl);
          console.log('User:', this.userEmail);
          console.log('Data:', data);
          
          // Use google.script.run to avoid CORS issues
          const response = await google.script.run({
            action: action,
            email: this.userEmail,
            ...data
          }, this.scriptUrl);
          
          console.log('üì• Received Response:', response);
          return response;
          
        } catch (error) {
          console.error('‚ùå API Error:', error);
          throw error;
        }
      }

      async initialize() {
        return this.request('initialize');
      }

      async getItems() {
        return this.request('getItems');
      }

      async addItem(itemData) {
        return this.request('addItem', itemData);
      }

      async getUsers() {
        return this.request('getUsers');
      }

      async getBookings() {
        return this.request('getBookings');
      }

      async createBooking(bookingData) {
        return this.request('createBooking', bookingData);
      }

      async updateBookingStatus(bookingId, action) {
        return this.request('updateBookingStatus', {
          bookingId,
          action
        });
      }

      async getLoadings() {
        return this.request('getLoadings');
      }

      async createLoading(loadingData) {
        return this.request('createLoading', loadingData);
      }

      async getTransactions() {
        return this.request('getTransactions');
      }

      async createTransaction(transactionData) {
        return this.request('createTransaction', transactionData);
      }

      async getInventory() {
        return this.request('getInventory');
      }

      async getDispatch() {
        return this.request('getDispatch');
      }

      async createDispatch(dispatchData) {
        return this.request('createDispatch', dispatchData);
      }

      async getReturns() {
        return this.request('getReturns');
      }

      async createReturn(returnData) {
        return this.request('createReturn', returnData);
      }

      async getAuditLog() {
        return this.request('getAuditLog');
      }

      async initializeSystem() {
        return this.request('initialize');
      }

      async generateDeliveryNote(loadId) {
        return this.request('generateDeliveryNote', { loadId });
      }

      async exportSheet(sheetName) {
        return this.request('exportSheet', { sheetName });
      }

      async importItems(items) {
        return this.request('importItems', { items });
      }
    }

    let api = null;

    // ============================================================================
    // SCRIPT URL MANAGEMENT
    // ============================================================================

    function saveScriptUrl() {
      const urlInput = document.getElementById('scriptUrlInput');
      const url = urlInput.value.trim();
      
      console.log('üíæ Saving Script URL:', url);
      
      if (!url) {
        alert('‚ùå Please enter your Google Apps Script Web App URL');
        return;
      }
      
      // Basic validation
      if (!url.includes('script.google.com') && !url.includes('google.com')) {
        alert('‚ö†Ô∏è Warning: This URL does not look like a Google Apps Script URL.\n\nPlease copy the exact URL from:\nGoogle Apps Script ‚Üí Deploy ‚Üí Web App');
      }
      
      if (!url.includes('/exec')) {
        alert('‚ö†Ô∏è Warning: URL should end with /exec\n\nYour URL: ' + url);
      }
      
      // Save to localStorage
      localStorage.setItem('godown_erp_script_url', url);
      
      // Enable login
      document.getElementById('loginBtn').disabled = false;
      document.getElementById('userEmail').disabled = false;
      document.getElementById('userRole').disabled = false;
      
      alert('‚úÖ Script URL saved!\n\nüí° You can now login.');
    }

    function loadScriptUrl() {
      const savedUrl = localStorage.getItem('godown_erp_script_url');
      
      if (savedUrl) {
        document.getElementById('scriptUrlInput').value = savedUrl;
        document.getElementById('loginBtn').disabled = false;
        document.getElementById('userEmail').disabled = false;
        document.getElementById('userRole').disabled = false;
      }
    }

    // ============================================================================
    // AUTHENTICATION & INITIALIZATION
    // ============================================================================

    function login() {
      const email = document.getElementById('userEmail').value.trim();
      const role = document.getElementById('userRole').value;
      const url = document.getElementById('scriptUrlInput').value.trim();

      console.log('üîë Logging in...');
      console.log('Email:', email);
      console.log('Role:', role);
      console.log('Script URL:', url);

      if (!email) {
        alert('‚ùå Please enter your email');
        return;
      }

      if (!url) {
        alert('‚ùå Please enter your Google Apps Script Web App URL');
        return;
      }

      currentUserEmail = email;
      currentUserRole = role;
      SCRIPT_URL = url;
      api = new GoogleSheetsAPI(SCRIPT_URL, email);

      // Save to localStorage
      localStorage.setItem('godown_erp_script_url', url);
      localStorage.setItem('godown_erp_user_email', email);
      localStorage.setItem('godown_erp_user_role', role);

      document.getElementById('mainContent').style.display = 'block';
      updateUIForRole();
      loadAllData();
      
      alert('‚úÖ Logged in successfully as ' + role);
    }

    function updateUIForRole() {
      const addItemBtn = document.getElementById('addItemBtn');
      const createBookingBtn = document.getElementById('createBookingBtn');
      const createLoadingBtn = document.getElementById('createLoadingBtn');
      const createTransactionBtn = document.getElementById('createTransactionBtn');
      const auditTab = document.getElementById('auditTab');

      // Reset all buttons
      addItemBtn.style.display = 'none';
      createBookingBtn.style.display = 'none';
      createLoadingBtn.style.display = 'none';
      createTransactionBtn.style.display = 'none';
      auditTab.style.display = 'none';

      if (currentUserRole === 'ADMIN') {
        addItemBtn.style.display = 'block';
        createBookingBtn.style.display = 'block';
        createLoadingBtn.style.display = 'block';
        createTransactionBtn.style.display = 'block';
        auditTab.style.display = 'block';
      } else if (currentUserRole === 'GODOWN') {
        addItemBtn.style.display = 'block';
        createLoadingBtn.style.display = 'block';
        createTransactionBtn.style.display = 'block';
        auditTab.style.display = 'none';
      } else if (currentUserRole === 'SALESMAN') {
        createBookingBtn.style.display = 'block';
        auditTab.style.display = 'none';
      }
    }

    // ============================================================================
    // DATA LOADING
    // ============================================================================

    async function loadAllData() {
      console.log('üìä Loading all data...');
      try {
        const results = await Promise.all([
          api.getItems(),
          api.getBookings(),
          api.getLoadings(),
          api.getTransactions(),
          api.getInventory()
        ]);
        
        itemsData = results[0].items || [];
        renderItems(results[0].items);
        renderBookings(results[1].bookings);
        renderLoadings(results[2].loadings);
        renderTransactions(results[3].transactions);
        renderInventory(results[4].inventory);
        
        updateStats();
        
        console.log('‚úÖ All data loaded successfully');
      } catch (error) {
        console.error('‚ùå Error loading data:', error);
        alert('‚ùå Error loading data: ' + error.message);
      }
    }

    // ============================================================================
    // RENDERING
    // ============================================================================

    function renderInventory(inventory) {
      const tbody = document.getElementById('inventoryTableBody');
      
      if (!inventory || inventory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No items found</td></tr>';
        return;
      }

      tbody.innerHTML = inventory.map(item => {
        const stockClass = item.availableStock < item.minStock ? 'inventory-low' : 'inventory-ok';
        return `
          <tr>
            <td><strong>${item.itemName}</strong></td>
            <td>${item.category}</td>
            <td>${item.unit}</td>
            <td>${item.minStock}</td>
            <td>${item.currentStock}</td>
            <td>${item.reservedStock}</td>
            <td><span class="status-badge ${stockClass}">${item.availableStock}</span></td>
            <td><span class="status-badge status-approved">${item.status || 'Active'}</span></td>
          </tr>
        `;
      }).join('');
    }

    function renderBookings(bookings) {
      const tbody = document.getElementById('bookingsTableBody');
      
      if (!bookings || bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No bookings found</td></tr>';
        return;
      }

      tbody.innerHTML = bookings.map(booking => {
        const statusClass = `status-${booking.status.toLowerCase()}`;
        const item = itemsData.find(i => i.id === booking.itemId) || { itemName: 'Unknown' };
        const actions = getBookingActions(booking);
        
        return `
          <tr>
            <td><small>${booking.id.substring(0, 8)}...</small></td>
            <td>${new Date(booking.date).toLocaleDateString()}</td>
            <td><strong>${booking.shop}</strong></td>
            <td>${item.itemName}</td>
            <td>${booking.orderedQty}</td>
            <td><span class="status-badge ${statusClass}">${booking.status}</span></td>
            <td>${actions}</td>
          </tr>
        `;
      }).join('');
    }

    function renderLoadings(loadings) {
      const tbody = document.getElementById('loadingsTableBody');
      
      if (!loadings || loadings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No loadings found</td></tr>';
        return;
      }

      tbody.innerHTML = loadings.map(loading => {
        const statusClass = `status-${loading.loadStatus.toLowerCase()}`;
        const item = itemsData.find(i => i.id === loading.itemId) || { itemName: 'Unknown' };
        
        return `
          <tr>
            <td><small>${loading.id.substring(0, 8)}...</small></td>
            <td><small>${loading.bookingId.substring(0, 8)}...</small></td>
            <td>${item.itemName}</td>
            <td>${loading.orderedQty}</td>
            <td><strong>${loading.loadedQty}</strong></td>
            <td>${loading.dispatchMode}</td>
            <td>${loading.vehicleNo || '-'}</td>
            <td><span class="status-badge ${statusClass}">${loading.loadStatus}</span></td>
          </tr>
        `;
      }).join('');
    }

    function renderTransactions(transactions) {
      const tbody = document.getElementById('transactionsTableBody');
      
      if (!transactions || transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No transactions found</td></tr>';
        return;
      }

      tbody.innerHTML = transactions.map(tx => {
        const typeClass = `transaction-${tx.type.toLowerCase()}`;
        const item = itemsData.find(i => i.id === tx.itemId) || { itemName: 'Unknown' };
        const quantityClass = tx.quantity > 0 ? 'transaction-in' : 'transaction-out';
        
        return `
          <tr>
            <td>${new Date(tx.date).toLocaleString()}</td>
            <td><span class="status-badge ${typeClass}">${tx.type}</span></td>
            <td>${item.itemName}</td>
            <td><span class="${quantityClass}">${tx.quantity > 0 ? '+' : ''}${tx.quantity}</span></td>
            <td>${tx.source}</td>
            <td>${tx.handledByEmail}</td>
            <td><small>${tx.remarks || '-'}</small></td>
          </tr>
        `;
      }).join('');
    }

    function updateStats() {
      document.getElementById('totalItems').textContent = itemsData.length;
    }

    function getBookingActions(booking) {
      if (currentUserRole === 'SALESMAN') {
        return '<span class="role-badge role-salesman">View Only</span>';
      }
      
      if (currentUserRole === 'GODOWN' || currentUserRole === 'ADMIN') {
        if (booking.status === 'PENDING') {
          return `
            <button class="btn btn-success btn-sm" onclick="approveBooking('${booking.id}')">‚úì</button>
            <button class="btn btn-danger btn-sm" onclick="rejectBooking('${booking.id}')">‚úó</button>
          `;
        } else if (booking.status === 'APPROVED') {
          return '<span class="role-badge role-godown">Can Load</span>';
        }
      }
      
      return '-';
    }

    // ============================================================================
    // DROPDOWN POPULATION
    // ============================================================================

    function populateItemSelects() {
      const selects = ['newBookingItem', 'newTransactionItem'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select an item...</option>';
        
        itemsData.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = `${item.itemName} (${item.unit})`;
          select.appendChild(option);
        });
      });
    }

    function populateBookingSelect() {
      const select = document.getElementById('newLoadingBooking');
      select.innerHTML = '<option value="">Select a booking...</option>';
      
      const approvedBookings = itemsData.filter(i => i.status === 'APPROVED');
      
      approvedBookings.forEach(booking => {
        const option = document.createElement('option');
        option.value = booking.id;
        option.textContent = `${booking.shop} - ${booking.itemName} (${booking.orderedQty} ${booking.unit})`;
        select.appendChild(option);
      });
    }

    // ============================================================================
    // MODAL MANAGEMENT
    // ============================================================================

    function openAddItemModal() {
      document.getElementById('addItemModal').classList.add('active');
    }

    function openCreateBookingModal() {
      document.getElementById('createBookingModal').classList.add('active');
    }

    function openCreateLoadingModal() {
      document.getElementById('createLoadingModal').classList.add('active');
    }

    function openCreateTransactionModal() {
      document.getElementById('createTransactionModal').classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      
      if (modalId === 'addItemModal') {
        document.getElementById('newItemName').value = '';
        document.getElementById('newItemCategory').value = '';
        document.getElementById('newItemUnit').value = '';
        document.getElementById('newItemMinStock').value = '0';
      }
    }

    // ============================================================================
    // ACTIONS
    // ============================================================================

    async function initializeSystem() {
      try {
        if (!confirm('This will create all sheets and insert demo data.\n\n‚ö†Ô∏è This may take 30-60 seconds.\n\nContinue?')) {
          return;
        }
        
        console.log('üöÄ Initializing system...');
        const result = await api.initializeSystem();
        
        if (result.success) {
          console.log('Initialization result:', result);
          alert('‚úÖ ' + result.message);
          await loadAllData();
        } else {
          console.log('Initialization failed:', result);
          alert('‚ùå System initialization failed!\n\n' + result.message);
        }
      } catch (error) {
        console.error('Error initializing system:', error);
        alert('‚ùå Error initializing system: ' + error.message);
      }
    }

    async function saveNewItem() {
      try {
        const itemData = {
          itemName: document.getElementById('newItemName').value.trim(),
          category: document.getElementById('newItemCategory').value.trim(),
          unit: document.getElementById('newItemUnit').value.trim(),
          minStock: parseInt(document.getElementById('newItemMinStock').value) || 0,
          status: document.getElementById('newItemStatus').value
        };

        if (!itemData.itemName || !itemData.category || !itemData.unit) {
          alert('‚ùå Please fill in all required fields');
          return;
        }

        console.log('üíæ Saving item:', itemData);
        const result = await api.addItem(itemData);
        console.log('Save result:', result);
        
        alert('‚úÖ Item added successfully!');
        closeModal('addItemModal');
        await loadAllData();
      } catch (error) {
        console.error('‚ùå Error adding item:', error);
        alert('‚ùå Error adding item: ' + error.message);
      }
    }

    async function saveNewBooking() {
      try {
        const bookingData = {
          shop: document.getElementById('newBookingShop').value.trim(),
          itemId: document.getElementById('newBookingItem').value,
          orderedQty: parseInt(document.getElementById('newBookingQty').value) || 0
        };

        if (!bookingData.shop || !bookingData.itemId || bookingData.orderedQty <= 0) {
          alert('‚ùå Please fill in all required fields');
          return;
        }

        console.log('üìù Creating booking:', bookingData);
        const result = await api.createBooking(bookingData);
        console.log('Booking result:', result);
        
        alert('‚úÖ Booking created successfully!');
        closeModal('createBookingModal');
        await loadAllData();
      } catch (error) {
        console.error('‚ùå Error creating booking:', error);
        alert('‚ùå Error creating booking: ' + error.message);
      }
    }

    async function saveNewLoading() {
      try {
        const loadingData = {
          bookingId: document.getElementById('newLoadingBooking').value,
          itemId: '',
          loadedQty: parseInt(document.getElementById('newLoadingQty').value) || 0,
          dispatchMode: document.getElementById('newLoadingMode').value,
          vehicleNo: document.getElementById('newLoadingVehicle').value.trim()
        };

        if (!loadingData.bookingId || loadingData.loadedQty <= 0) {
          alert('‚ùå Please fill in all required fields');
          return;
        }

        console.log('üöõ Creating loading:', loadingData);
        const result = await api.createLoading(loadingData);
        console.log('Loading result:', result);
        
        alert('‚úÖ Loading created successfully! Stock updated via OUT transaction.');
        closeModal('createLoadingModal');
        await loadAllData();
      } catch (error) {
        console.error('‚ùå Error creating loading:', error);
        alert('‚ùå Error creating loading: ' + error.message);
      }
    }

    async function saveNewTransaction() {
      try {
        const transactionData = {
          type: document.getElementById('newTransactionType').value,
          source: document.getElementById('newTransactionSource').value,
          itemId: document.getElementById('newTransactionItem').value,
          quantity: parseInt(document.getElementById('newTransactionQty').value) || 0,
          remarks: document.getElementById('newTransactionRemarks').value.trim()
        };

        if (!transactionData.itemId || transactionData.quantity === 0) {
          alert('‚ùå Please fill in all required fields');
          return;
        }

        console.log('üí≥ Creating transaction:', transactionData);
        const result = await api.createTransaction(transactionData);
        console.log('Transaction result:', result);
        
        alert('‚úÖ Transaction created successfully! Stock updated.');
        closeModal('createTransactionModal');
        await loadAllData();
      } catch (error) {
        console.error('‚ùå Error creating transaction:', error);
        alert('‚ùå Error creating transaction: ' + error.message);
      }
    }

    async function approveBooking(bookingId) {
      try {
        if (!confirm('Approve this booking?')) {
          return;
        }
        
        console.log('‚úì Approving booking:', bookingId);
        const result = await api.updateBookingStatus(bookingId, 'APPROVE');
        console.log('Approval result:', result);
        
        alert('‚úÖ Booking approved!');
        await loadAllData();
      } catch (error) {
        console.error('‚ùå Error approving booking:', error);
        alert('‚ùå Error approving booking: ' + error.message);
      }
    }

    async function rejectBooking(bookingId) {
      try {
        if (!confirm('Reject this booking?')) {
          return;
        }
        
        console.log('‚úó Rejecting booking:', bookingId);
        const result = await api.updateBookingStatus(bookingId, 'REJECT');
        console.log('Rejection result:', result);
        
        alert('‚úÖ Booking rejected!');
        await loadAllData();
      } catch (error) {
        console.error('‚ùå Error rejecting booking:', error);
        alert('‚ùå Error rejecting booking: ' + error.message);
      }
    }

    // ============================================================================
    // TAB MANAGEMENT
    // ============================================================================

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      document.getElementById(tabName + 'Tab').classList.add('active');
      event.target.classList.add('active');
    }

    // ============================================================================
    // EVENT LISTENERS
    // ============================================================================

    document.getElementById('newLoadingBooking').addEventListener('change', function() {
      const bookingId = this.value;
      const maxQtySpan = document.getElementById('loadingMaxQty');
      
      if (bookingId) {
        const selectedOption = this.options[this.selectedIndex];
        const text = selectedOption.textContent;
        const match = text.match(/\((\d+)\s+(\w+)\)$/);
        if (match) {
          maxQtySpan.textContent = `Max: ${match[1]} ${match[2]}`;
        }
      } else {
        maxQtySpan.textContent = '';
      }
    });

    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(modal => {
          modal.classList.remove('active');
        });
      }
    });

    // ============================================================================
    // PAGE LOAD
    // ============================================================================

    window.onload = function() {
      console.log('üìÑ Page loaded');
      loadScriptUrl();
    };
  </script>
</body>
</html>
